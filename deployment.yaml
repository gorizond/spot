apiVersion: v1
kind: ServiceAccount
metadata:
  name: spot-node-label-reader
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: spot-node-label-reader
rules:
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: spot-node-label-reader
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: spot-node-label-reader
subjects:
  - kind: ServiceAccount
    name: spot-node-label-reader
    namespace: spot-system
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: ros2-smoke
  labels:
    app.kubernetes.io/name: ros2-smoke
    app.kubernetes.io/part-of: spot
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: ros2-smoke
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ros2-smoke
        app.kubernetes.io/part-of: spot
    spec:
      serviceAccountName: spot-node-label-reader
      nodeSelector:
        kubernetes.io/arch: arm64
        gorizond.io/robot: "true"
      containers:
        - name: node-label-config
          image: ghcr.io/gorizond/spot-node-label-config-cpp:latest
          imagePullPolicy: Always
          env:
            - name: RMW_IMPLEMENTATION
              value: "rmw_fastrtps_cpp"
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: LABEL_PREFIX
              value: "gorizond.io/spot-pca9685-"
            - name: TOPIC
              value: "/spot/config/servo_map"
            - name: K8S_BASE
              value: "https://kubernetes.default.svc"
            - name: WATCH_TIMEOUT_SECONDS
              value: "30"
            - name: REQUEST_TIMEOUT_SECONDS
              value: "35"
            - name: BACKOFF_MAX_SECONDS
              value: "30"
          command: ["bash", "-lc"]
          args:
            - |
              set -eo pipefail
              source /opt/ros/kilted/setup.bash
              source /opt/spot_node_label_config_cpp/share/spot_node_label_config_cpp/local_setup.bash
              exec ros2 run spot_node_label_config_cpp spot_node_label_config_cpp_node
          volumeMounts: []
        - name: servo-driver
          image: ghcr.io/gorizond/spot-servo-driver-cpp:latest
          imagePullPolicy: Always
          securityContext:
            privileged: true
            runAsUser: 0
            runAsGroup: 0
            allowPrivilegeEscalation: true
          env:
            - name: SERVO_MAP_TOPIC
              value: "/spot/config/servo_map"
            - name: CMD_TOPIC
              value: "/spot/cmd/servo"
            - name: STATUS_TOPIC
              value: "/spot/state/servo"
            - name: PWM_HZ
              value: "50"
            - name: UPDATE_HZ
              value: "20"
            - name: MAX_SLEW_US_PER_S
              value: "1200"
            - name: SAFE_MIN_US
              value: "100"
            - name: SAFE_MAX_US
              value: "3000"
            - name: START_ARMED
              value: "0"
            - name: DISARM_FULL_OFF
              value: "1"
          command: ["bash", "-lc"]
          args:
            - |
              set -eo pipefail
              source /opt/ros/kilted/setup.bash
              source /opt/spot_servo_driver_cpp/share/spot_servo_driver_cpp/local_setup.bash
              exec ros2 run spot_servo_driver_cpp spot_servo_driver_cpp_node
          volumeMounts:
            - name: i2c-1
              mountPath: /dev/i2c-1
        - name: cmd-mux
          image: ghcr.io/gorizond/spot-cmd-mux-cpp:latest
          imagePullPolicy: Always
          env:
            - name: AUTO_TOPIC
              value: "/spot/cmd/servo_auto"
            - name: MANUAL_TOPIC
              value: "/spot/cmd/servo_manual"
            - name: OUT_TOPIC
              value: "/spot/cmd/servo"
            - name: MODE_TOPIC
              value: "/spot/ctrl/mode"
            - name: STATUS_TOPIC
              value: "/spot/state/mux"
            - name: DEFAULT_MODE
              value: "auto"
            - name: MANUAL_TIMEOUT_S
              value: "0"
            - name: STATUS_PUBLISH_S
              value: "1.0"
          command: ["bash", "-lc"]
          args:
            - |
              set -eo pipefail
              source /opt/ros/kilted/setup.bash
              source /opt/spot_cmd_mux_cpp/share/spot_cmd_mux_cpp/local_setup.bash
              exec ros2 run spot_cmd_mux_cpp spot_cmd_mux_cpp_node
          volumeMounts: []
      volumes:
        - name: spot-node-label-config
          configMap:
            name: spot-node-label-config
            defaultMode: 0555
            items:
              - key: spot_cli.py
                path: spot_cli.py
        - name: i2c-1
          hostPath:
            path: /dev/i2c-1
            type: CharDevice

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: spot-champ
  labels:
    app.kubernetes.io/name: spot-champ
    app.kubernetes.io/part-of: spot
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: spot-champ
  template:
    metadata:
      labels:
        app.kubernetes.io/name: spot-champ
        app.kubernetes.io/part-of: spot
    spec:
      nodeSelector:
        kubernetes.io/arch: arm64
        gorizond.io/robot: "true"
        gorizond.io/spot-champ: "true"
      containers:
        - name: champ-controller
          image: ghcr.io/gorizond/spot-champ:main
          imagePullPolicy: Always
          env:
            - name: PYTHONUNBUFFERED
              value: "1"
          command: ["bash", "-lc"]
          args:
            - |
              set -eo pipefail
              source /opt/ros/kilted/setup.bash
              if [ -f /ws/install/setup.bash ]; then
                source /ws/install/setup.bash
              fi

              CHAMP_BASE_PREFIX="$(ros2 pkg prefix champ_base 2>/dev/null || true)"
              EKF_DIR="${CHAMP_BASE_PREFIX}/share/champ_base/config/ekf"
              if [ -d "${EKF_DIR}" ]; then
                if [ -f /opt/spot/champ/ekf/base_to_footprint.yaml ]; then
                  cp /opt/spot/champ/ekf/base_to_footprint.yaml "${EKF_DIR}/base_to_footprint.yaml" || true
                fi
                if [ -f /opt/spot/champ/ekf/footprint_to_odom.yaml ]; then
                  cp /opt/spot/champ/ekf/footprint_to_odom.yaml "${EKF_DIR}/footprint_to_odom.yaml" || true
                fi
              fi

              exec ros2 launch champ_bringup bringup.launch.py \
                rviz:=false use_sim_time:=false gazebo:=false \
                description_path:=/opt/spot/champ/spotmicroai.urdf.xacro \
                joints_map_path:=/opt/spot/champ/joints_ros2.yaml \
                links_map_path:=/opt/spot/champ/links_ros2.yaml \
                gait_config_path:=/opt/spot/champ/gait_ros2.yaml \
                publish_joint_states:=true publish_joint_control:=false
          volumeMounts:
            - name: spot-node-label-config
              mountPath: /opt/spot
              readOnly: true
        - name: champ-bridge
          image: ghcr.io/gorizond/spot-champ-bridge-cpp:latest
          imagePullPolicy: Always
          env:
            - name: CHAMP_GAIN
              value: "0.50"
            - name: CHAMP_UPPER_RANGE_RAD
              value: "1.30"
            - name: CHAMP_LOWER_RANGE_RAD
              value: "1.30"
            - name: CHAMP_BRIDGE_HZ
              value: "20"
            - name: STAND_HIP
              value: "0.02"
            - name: STAND_UPPER
              value: "0.05"
            - name: STAND_LOWER
              value: "0.05"
            - name: STAND_HIP_REAR_OFFSET
              value: "0.0"
            - name: STAND_REAR_UPPER_OFFSET
              value: "0.0"
            - name: STAND_REAR_LOWER_OFFSET
              value: "0.0"
            - name: JOINT_STATES_TOPIC
              value: "/joint_states"
            - name: CMD_TOPIC
              value: "/spot/cmd/servo_auto"
          command: ["bash", "-lc"]
          args:
            - |
              set -eo pipefail
              source /opt/ros/kilted/setup.bash
              source /opt/spot_champ_bridge_cpp/share/spot_champ_bridge_cpp/local_setup.bash
              exec ros2 run spot_champ_bridge_cpp spot_champ_bridge_cpp_node
          volumeMounts: []
      volumes:
        - name: spot-node-label-config
          configMap:
            name: spot-node-label-config
            defaultMode: 0555
            items:
              - key: spotmicroai.urdf.xacro
                path: champ/spotmicroai.urdf.xacro
              - key: joints_ros2.yaml
                path: champ/joints_ros2.yaml
              - key: links_ros2.yaml
                path: champ/links_ros2.yaml
              - key: gait_ros2.yaml
                path: champ/gait_ros2.yaml
              - key: base_to_footprint.yaml
                path: champ/ekf/base_to_footprint.yaml
              - key: footprint_to_odom.yaml
                path: champ/ekf/footprint_to_odom.yaml
